import express from "express";import cors from "cors";import multer from "multer";import { onRequest } from "firebase-functions/v2/https";const app=express();app.use(cors({origin:true}));app.use(express.json({limit:"10mb"}));app.get("/",(req,res)=>res.status(200).send("OK"));const upload=multer({storage:multer.memoryStorage()});app.post("/upload",upload.array("files"),async(req,res)=>{const files=(req.files||[]).map((f,i)=>({id:`${Date.now()}_${i}`,name:f.originalname,size:f.size,mime:f.mimetype}));return res.json({files})});app.post("/contradictions",async(req,res)=>{const {message="",evidence=[]}=req.body||{};const contradictions=[];if(message.includes("cannot")&&message.includes("can")){contradictions.push({source:"message",claim:"can",contradicts:"cannot"})}for(const f of evidence){if(f.name&&/draft/i.test(f.name)){contradictions.push({source:f.name,claim:"final",contradicts:"draft"})}}return res.json({contradictions})});app.post("/query",async(req,res)=>{const {message="",constitution="",enforceConstitution=true,runContradictions=true,evidence=[]}=req.body||{};const preface=enforceConstitution?"Constitution enforced: no fabrication, preserve due process. ":"Unconstrained mode. ";let reply=preface+"Echo: "+message;let contradictions=[];if(runContradictions){if(message.match(/\bnot\b/i)&&message.match(/\bis\b/i)){contradictions.push({source:"message",claim:"is",contradicts:"not"})}}return res.json({reply,contradictions})});export const api=onRequest({region:"us-central1",cors:true,timeoutSeconds:60,memory:"256MiB"},app);